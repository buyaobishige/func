<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>wurank数据库开发文档 | 林祥子的文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/func/logo.svg">
    <link rel="manifest" href="/func/manifest.json">
    <link rel="apple-touch-icon" href="/func/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/func/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="基于Vuepress的功能部博客">
    <meta name="author" content="func">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/func/assets/css/0.styles.94edebd6.css" as="style"><link rel="preload" href="/func/assets/js/app.25566812.js" as="script"><link rel="preload" href="/func/assets/js/2.cfd2aafd.js" as="script"><link rel="preload" href="/func/assets/js/1.959a7dda.js" as="script"><link rel="preload" href="/func/assets/js/23.3ebb0e0e.js" as="script"><link rel="preload" href="/func/assets/js/4.4f3ff79f.js" as="script"><link rel="preload" href="/func/assets/js/18.8d0a14c5.js" as="script"><link rel="prefetch" href="/func/assets/js/10.d1f8a545.js"><link rel="prefetch" href="/func/assets/js/11.83ee45e6.js"><link rel="prefetch" href="/func/assets/js/12.5aa091df.js"><link rel="prefetch" href="/func/assets/js/13.61f6c833.js"><link rel="prefetch" href="/func/assets/js/14.d8e1b48e.js"><link rel="prefetch" href="/func/assets/js/15.a889dc1b.js"><link rel="prefetch" href="/func/assets/js/16.291ac9d9.js"><link rel="prefetch" href="/func/assets/js/17.d6183440.js"><link rel="prefetch" href="/func/assets/js/19.f098136a.js"><link rel="prefetch" href="/func/assets/js/20.c7157ec1.js"><link rel="prefetch" href="/func/assets/js/21.974e2450.js"><link rel="prefetch" href="/func/assets/js/22.7a8b72fa.js"><link rel="prefetch" href="/func/assets/js/24.d3d3c175.js"><link rel="prefetch" href="/func/assets/js/25.3b0d5f0d.js"><link rel="prefetch" href="/func/assets/js/26.5696957f.js"><link rel="prefetch" href="/func/assets/js/27.aef0f6ec.js"><link rel="prefetch" href="/func/assets/js/28.3bddc70c.js"><link rel="prefetch" href="/func/assets/js/29.d384c07a.js"><link rel="prefetch" href="/func/assets/js/3.799f8d22.js"><link rel="prefetch" href="/func/assets/js/30.69c0d040.js"><link rel="prefetch" href="/func/assets/js/31.fb2b3451.js"><link rel="prefetch" href="/func/assets/js/32.e75403f7.js"><link rel="prefetch" href="/func/assets/js/33.cbb42dbf.js"><link rel="prefetch" href="/func/assets/js/34.06d3621c.js"><link rel="prefetch" href="/func/assets/js/35.340600fa.js"><link rel="prefetch" href="/func/assets/js/36.2dd16318.js"><link rel="prefetch" href="/func/assets/js/37.65d1c612.js"><link rel="prefetch" href="/func/assets/js/38.a6667f32.js"><link rel="prefetch" href="/func/assets/js/39.91718eec.js"><link rel="prefetch" href="/func/assets/js/40.f40ff10b.js"><link rel="prefetch" href="/func/assets/js/41.36a8e38b.js"><link rel="prefetch" href="/func/assets/js/42.db11803e.js"><link rel="prefetch" href="/func/assets/js/43.516090da.js"><link rel="prefetch" href="/func/assets/js/44.9470a868.js"><link rel="prefetch" href="/func/assets/js/45.fd60a124.js"><link rel="prefetch" href="/func/assets/js/46.9b7d7cc2.js"><link rel="prefetch" href="/func/assets/js/47.69dd2a8d.js"><link rel="prefetch" href="/func/assets/js/48.d6f4eaad.js"><link rel="prefetch" href="/func/assets/js/49.18b4f8ea.js"><link rel="prefetch" href="/func/assets/js/5.b4cb2a6c.js"><link rel="prefetch" href="/func/assets/js/50.874af25a.js"><link rel="prefetch" href="/func/assets/js/51.9b99ccc6.js"><link rel="prefetch" href="/func/assets/js/52.aa933f9d.js"><link rel="prefetch" href="/func/assets/js/53.1495fec9.js"><link rel="prefetch" href="/func/assets/js/54.dd66def3.js"><link rel="prefetch" href="/func/assets/js/55.bfcf65ed.js"><link rel="prefetch" href="/func/assets/js/56.1515f411.js"><link rel="prefetch" href="/func/assets/js/57.5aa62846.js"><link rel="prefetch" href="/func/assets/js/58.db55929e.js"><link rel="prefetch" href="/func/assets/js/59.8f6f45a4.js"><link rel="prefetch" href="/func/assets/js/60.bb6f054d.js"><link rel="prefetch" href="/func/assets/js/61.c8602e95.js"><link rel="prefetch" href="/func/assets/js/62.94ac2c96.js"><link rel="prefetch" href="/func/assets/js/63.6775b986.js"><link rel="prefetch" href="/func/assets/js/64.c33bc1e9.js"><link rel="prefetch" href="/func/assets/js/8.bcd7b08f.js"><link rel="prefetch" href="/func/assets/js/9.fb5567ee.js"><link rel="prefetch" href="/func/assets/js/vendors~docsearch.992c13e1.js">
    <link rel="stylesheet" href="/func/assets/css/0.styles.94edebd6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/func/" class="home-link router-link-active"><!----> <span class="site-name">林祥子的文档</span></a> <div class="links"><div class="pictureSwitchBox"><img src="/func/pictureOn.svg"></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/func/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          会议记录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/func/lin/session1.html" class="nav-link">
  第一次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session2.html" class="nav-link">
  第二次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session3.html" class="nav-link">
  第三次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session4.html" class="nav-link">
  第四次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session5.html" class="nav-link">
  第五次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session6.html" class="nav-link">
  第六次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session7.html" class="nav-link">
  第七次晚自习
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的记录" class="dropdown-title"><span class="title">我的记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/func/lin/reportDevDoc.html" class="nav-link">
  咨询报告开发文档
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/rhj1.html" class="nav-link">
  任鸿隽教育思想
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/spssMaps.html" class="nav-link">
  SPSS学习目录
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/func/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          会议记录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/func/lin/session1.html" class="nav-link">
  第一次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session2.html" class="nav-link">
  第二次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session3.html" class="nav-link">
  第三次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session4.html" class="nav-link">
  第四次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session5.html" class="nav-link">
  第五次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session6.html" class="nav-link">
  第六次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session7.html" class="nav-link">
  第七次晚自习
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的记录" class="dropdown-title"><span class="title">我的记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/func/lin/reportDevDoc.html" class="nav-link">
  咨询报告开发文档
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/rhj1.html" class="nav-link">
  任鸿隽教育思想
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/spssMaps.html" class="nav-link">
  SPSS学习目录
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>wurank数据库开发文档</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/func/lin/DBdoc.html#结构介绍" class="sidebar-link">结构介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/func/lin/DBdoc.html#各表格-保质期-暂行" class="sidebar-link">各表格“保质期”（暂行）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/func/lin/DBdoc.html#c区表格介绍" class="sidebar-link">C区表格介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#competition-and-party" class="sidebar-link">competitionandparty</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#enrollment-b" class="sidebar-link">enrollment_b</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#school-major-b" class="sidebar-link">schoolmajorb</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#enrollment-z" class="sidebar-link">enrollment_z</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#research" class="sidebar-link">research</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#research-jiangxiang" class="sidebar-link">research_jiangxiang</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#sch-basic-data" class="sidebar-link">schbasicdata</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#sch-manually-processed-data" class="sidebar-link">schmanuallyprocessed_data</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#sch-report-data-gbbk-gzgz" class="sidebar-link">schreportdatagbbkgzgz</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#sch-report-data-mbdy" class="sidebar-link">schreportdata_mbdy</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#school-major-b-2" class="sidebar-link">schoolmajorb</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#school-major-z" class="sidebar-link">schoolmajorz</a></li></ul></li><li><a href="/func/lin/DBdoc.html#h区表格介绍" class="sidebar-link">H区表格介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/func/lin/DBdoc.html#i区表格介绍" class="sidebar-link">I区表格介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#book-info" class="sidebar-link">book_info</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#competition-and-party-info" class="sidebar-link">competitionandparty_info</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#jiangxiang-info" class="sidebar-link">jiangxiang_info</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#paper-info" class="sidebar-link">paper_info</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#patent-info" class="sidebar-link">patent_info</a></li></ul></li><li><a href="/func/lin/DBdoc.html#m区表格介绍" class="sidebar-link">M区表格介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/func/lin/DBdoc.html#o区表格介绍" class="sidebar-link">O区表格介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#config-table" class="sidebar-link">config_table</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#readme" class="sidebar-link">_readme_</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc.html#table-update-time" class="sidebar-link">tableupdatetime</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="wurank数据库开发文档"><a href="#wurank数据库开发文档" class="header-anchor">#</a> wurank数据库开发文档</h1> <div class="custom-block tip"><p class="custom-block-title">小贴士</p> <p>目前已可局域网访问。暂时无法在公网访问。</p></div> <h2 id="结构介绍"><a href="#结构介绍" class="header-anchor">#</a> 结构介绍</h2> <p><img src="/func/assets/img/DBstructure.21b5aba1.jpg" alt="aa"></p> <p>这里将既有数据分为C、I、M、H、O五个区，赋予不同的功能。</p> <ul><li><p><code>C区</code>的字段数很精简，参与各种计算。例如，论文、专利、奖项、著作、学生竞赛、党建、艺术作品、就业质量报告数据、院校基本情况等数据需要月度频繁更新，每月大概要向C区更新50-100万条数据。<span class="badge tip" style="vertical-align:top;" data-v-0d148f50>重要</span></p></li> <li><p><code>I区</code>和<code>C区</code>数据关联，仅用于向用户展示。例如，出于性能考虑，<code>C区</code>只存储论文的学科归属、得分信息，但不存储论文名称、期刊等具体信息。这些基本不参与计算的信息由<code>I区</code>存储，可向用户进行展示。</p></li> <li><p><code>H区</code>用于局部备份。对于每条数据的改动予以记录，允许版本回退。</p></li></ul> <details class="custom-block details"><summary>为表格添加局部备份功能代码（基于mysql的trigger实现）</summary> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> mysql<span class="token punctuation">.</span>connector
<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> closing
<span class="token keyword">import</span> re

<span class="token comment"># MySQL 连接参数</span>
db_config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'host'</span><span class="token punctuation">:</span> <span class="token string">'192.168.0.91'</span><span class="token punctuation">,</span>
    <span class="token string">'user'</span><span class="token punctuation">:</span> <span class="token string">'wu'</span><span class="token punctuation">,</span>
    <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'xZ7FwtAD5HnhajxJ'</span><span class="token punctuation">,</span>
    <span class="token string">'database'</span><span class="token punctuation">:</span> <span class="token string">'wurank'</span><span class="token punctuation">,</span>
    <span class="token string">'charset'</span><span class="token punctuation">:</span> <span class="token string">'utf8mb4'</span>  <span class="token comment"># 设置字符集</span>
<span class="token punctuation">}</span>


<span class="token comment"># 获取表的列名</span>
<span class="token keyword">def</span> <span class="token function">get_columns</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;SHOW COLUMNS FROM `</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">`&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>column<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> column <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># 删除历史表（如果存在）</span>
<span class="token keyword">def</span> <span class="token function">drop_history_table_if_exists</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    history_table <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_history&quot;</span></span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;SHOW TABLES LIKE '</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">'&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;History table </span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string"> already exists. Dropping it.&quot;</span></span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;DROP TABLE IF EXISTS `</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">`&quot;</span></span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 创建历史表</span>
<span class="token keyword">def</span> <span class="token function">create_history_table</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    columns <span class="token operator">=</span> get_columns<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
    history_table <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_history&quot;</span></span>
    columns_definition <span class="token operator">=</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;`</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">` VARCHAR(255)&quot;</span></span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns<span class="token punctuation">]</span><span class="token punctuation">)</span>
    history_table_sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;
    CREATE TABLE `</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">` (
        </span><span class="token interpolation"><span class="token punctuation">{</span>columns_definition<span class="token punctuation">}</span></span><span class="token string">,
        `change_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        `change_type` VARCHAR(10)
    ) CHARACTER SET utf8mb4;
    &quot;&quot;&quot;</span></span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>history_table_sql<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;History table </span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string"> created.&quot;</span></span><span class="token punctuation">)</span>

<span class="token comment"># 删除表上的所有触发器</span>
<span class="token keyword">def</span> <span class="token function">delete_triggers</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;SHOW TRIGGERS LIKE '</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">';&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> trigger <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        trigger_name <span class="token operator">=</span> trigger<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Deleting trigger: </span><span class="token interpolation"><span class="token punctuation">{</span>trigger_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;DROP TRIGGER IF EXISTS `</span><span class="token interpolation"><span class="token punctuation">{</span>trigger_name<span class="token punctuation">}</span></span><span class="token string">`;&quot;</span></span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 创建触发器 SQL</span>
<span class="token keyword">def</span> <span class="token function">create_trigger_sql</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> history_table<span class="token punctuation">,</span> trigger_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    action <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'INSERT'</span><span class="token punctuation">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> <span class="token string">'UPDATE'</span><span class="token punctuation">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">:</span> <span class="token string">'OLD'</span><span class="token punctuation">}</span><span class="token punctuation">[</span>trigger_type<span class="token punctuation">]</span>
    action_fields <span class="token operator">=</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>action<span class="token punctuation">}</span></span><span class="token string">.`</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">`'</span></span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns<span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    history_columns <span class="token operator">=</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;`</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">`&quot;</span></span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'change_at'</span><span class="token punctuation">,</span> <span class="token string">'change_type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    action_values <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>action_fields<span class="token punctuation">}</span></span><span class="token string">, NOW(), '</span><span class="token interpolation"><span class="token punctuation">{</span>trigger_type<span class="token punctuation">}</span></span><span class="token string">'&quot;</span></span>

    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;
    CREATE TRIGGER `</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>trigger_type<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">`
    BEFORE </span><span class="token interpolation"><span class="token punctuation">{</span>trigger_type<span class="token punctuation">}</span></span><span class="token string"> ON `</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">`
    FOR EACH ROW
    BEGIN
        SET @trigger_status = (SELECT status FROM config_table WHERE config_item = '</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_trigger');
        IF @trigger_status = 1 THEN
            INSERT INTO `</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">` (</span><span class="token interpolation"><span class="token punctuation">{</span>history_columns<span class="token punctuation">}</span></span><span class="token string">)
            VALUES (</span><span class="token interpolation"><span class="token punctuation">{</span>action_values<span class="token punctuation">}</span></span><span class="token string">);
        END IF;
    END;
    &quot;&quot;&quot;</span></span>

<span class="token comment"># 创建所有触发器</span>
<span class="token keyword">def</span> <span class="token function">create_triggers</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    columns <span class="token operator">=</span> get_columns<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
    history_table <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_history&quot;</span></span>
    
    <span class="token keyword">for</span> trigger_type <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'INSERT'</span><span class="token punctuation">,</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        trigger_sql <span class="token operator">=</span> create_trigger_sql<span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> history_table<span class="token punctuation">,</span> trigger_type<span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>trigger_sql<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 主函数</span>
<span class="token keyword">def</span> <span class="token function">update_triggers</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> closing<span class="token punctuation">(</span>mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token operator">**</span>db_config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">,</span> closing<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SET NAMES utf8mb4;&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 设置会话字符集</span>
            drop_history_table_if_exists<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            create_history_table<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            delete_triggers<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            create_triggers<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;触发器和历史表更新成功: </span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string"> 表的触发器和历史表已更新！&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;出现错误: </span><span class="token interpolation"><span class="token punctuation">{</span>err<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    table_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sch_report_data_gbbk_gzgz'</span><span class="token punctuation">]</span>  <span class="token comment"># 将表名作为参数传入</span>
    <span class="token keyword">for</span> table_name <span class="token keyword">in</span> table_names<span class="token punctuation">:</span>
        update_triggers<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span>
</code></pre></div></details> <ul><li><p><code>M区</code>是初步计算后得到的数据，用于最终月度排名的计算，以及向用户进行展示。大部分数据预处理逻辑已完成。例如，对500万条论文数据进行计算，得到的按学校-学科分类加总分数，由M区存储，用于下一步计算。</p></li> <li><p><code>O区</code>用于部分交互行为。</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">long_id的编写说明</p> <p>对于已有唯一号的，均予以保留。</p> <p>未统一编号的，所使用的long_id形如B24111903002492。</p> <ul><li>第1位B（公办）本科/M民办本科/Z高职高专与职业大学，区分公办民办本科和职专（B有时会指公办民办本科，M不单列）。</li> <li>2-7位填上传日期。</li> <li>8-9位填上传时的领域，例如有10种不同竞赛，那么这两位可以依次填01-10，只要与本地文件保持一直即可。</li> <li>10-15填递增序号。</li></ul></div> <h2 id="各表格-保质期-暂行"><a href="#各表格-保质期-暂行" class="header-anchor">#</a> 各表格“保质期”（暂行）</h2> <ul><li>论文表：1年 ？ 不清楚未来是否完全废弃引用得分。</li> <li>著作表（需单列）：3个月</li> <li>专利表：1年</li> <li>奖项表：永久（直接覆盖式更新）</li> <li>学生竞赛和党建表：永久（直接覆盖式更新）</li></ul> <p>过期后处理方法：整表替换，或保留最初一年的资料，其他年份数据全部替换。</p> <div class="custom-block tip"><p class="custom-block-title">月度数据更新频次</p> <ol><li>国内SCD论文检索，已经是月更新的。一直在线服务的。</li> <li>国际SCDW论文检索，还没上线，打算实现月更新（全库数据准备工作还没搞完，后续可以做到只给月度增量数据，Sqlite格式）</li> <li>国内SCD图书检索，已经上线，打算实现季度更新（每次都是全库更新，去重动态计算，无法做到增量更新），全库1999-2024的MySQL数据已经交付</li> <li>国内SCD专利检索，已经上线，打算实现月更新。（后续可以做到只给月度增量数据，Sqlite格式）</li></ol></div> <h2 id="c区表格介绍"><a href="#c区表格介绍" class="header-anchor">#</a> C区表格介绍</h2> <h3 id="competition-and-party"><a href="#competition-and-party" class="header-anchor">#</a> competition_and_party</h3> <p>包含本科、民办、职专的所有党建、思政、各种学生竞赛数据。
为保证入库时结构统一，已按照<code>【1125定稿】竞赛名与赛道组别对照表.xlsx</code>重新梳理了所有竞赛的名称。今后入库时应按照最新名称入库。</p> <div class="custom-block tip"><p class="custom-block-title">关联表格</p> <p>此表与<code>competition_and_party_info</code> 关联</p></div> <details class="custom-block details"><summary>字段说明</summary> <p>long_id : 见<code>结构介绍</code></p> <p>category : 根据对照表填写，可选党建、思政、创新创业、数学、数学研、田径、艺术、英语、计算机、职校大赛、艺术展演。其中数学研仅限本科，职校大赛仅限职专。</p> <p>project_name : 根据对照表填写，第一级项目标题。</p> <p>sub_project : 第二级项目标题。</p> <p>sch name : 校名</p> <p>score : 最终得分</p> <p>end_year : 由于部分项目的年份信息为一个区间，所以这里取结束年份。</p> <p>type : 根据陈艺滨的要求暂时保留。目前未使用。</p></details> <h3 id="enrollment-b"><a href="#enrollment-b" class="header-anchor">#</a> enrollment_b</h3> <p>公办、民办本科招生人数数据和本硕博人数折算分。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>此表仅用于计算本科专业排名，切勿用于计算科研得分。计算科研得分请使用<code>school_major_b</code>表</p></div> <h3 id="school-major-b"><a href="#school-major-b" class="header-anchor">#</a> school_major_b</h3> <p>最终版招生专业情况。先经过了用各种数据对本科生招生数据进行增补调整，又经过了用研究生招生情况进行增补调整。适用于计算科研得分。</p> <h3 id="enrollment-z"><a href="#enrollment-z" class="header-anchor">#</a> enrollment_z</h3> <p>增补调整后的职专招生人数和开设专业数据。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>此表可直接用于计算科研得分</p></div> <h3 id="research"><a href="#research" class="header-anchor">#</a> research <span class="badge tip" style="vertical-align:top;" data-v-0d148f50>体积大</span></h3> <p>论文与专利数据。</p> <div class="custom-block warning"><p class="custom-block-title">特别注意</p> <p>计算本科科研得分时，须使用调整过的最终概率作为probability_all_in_one。此处应当跟子谦确认。</p></div> <div class="custom-block tip"><p class="custom-block-title">关联表格</p> <p>此表与<code>patent_info</code>和<code>paper_info</code>关联</p></div> <details class="custom-block details"><summary>字段说明</summary> <p>long_id : 论文对照号。</p> <p>date : 日期</p> <p>sch name : 校名</p> <p>basic_score : 论文发表基础得分。据此还可以倒推出作者数量和作者顺序。</p> <p>final_score : 论文最终得分。引用分=final_score - basic_score</p> <p>probability_all_in_one：本科专业类概率。</p> <p>from_db : SCD/SCDW/专利</p> <p>type : 发明专利/实用新型/外观设计</p> <p>sch_type : 本科/高职高专/民办独院</p></details> <h3 id="research-jiangxiang"><a href="#research-jiangxiang" class="header-anchor">#</a> research_jiangxiang</h3> <p>奖项数据。由于奖项在月度更新时，会发生无法追溯和预测的增删改，因此单列。</p> <div class="custom-block tip"><p class="custom-block-title">关联表格</p> <p>此表与<code>jiangxiang_info</code>关联</p></div> <details class="custom-block details"><summary>字段说明</summary> <p>long_id : 由子谦、陈艺滨提供。</p> <p>type : 国家知识产权局中国专利奖/省级教学成果奖/省级人文社科奖/教育部科学技术奖/教育部人文社科奖/国家级教学成果奖/国家级科学技术奖/省级科学技术奖</p> <p>其他字段与<code>research</code>表相同</p></details> <h3 id="sch-basic-data"><a href="#sch-basic-data" class="header-anchor">#</a> sch_basic_data</h3> <p>本科、专科的院校基本信息。其中，<code>sch_id</code>字段和院校历史变迁有关。</p> <h3 id="sch-manually-processed-data"><a href="#sch-manually-processed-data" class="header-anchor">#</a> sch_manually_processed_data</h3> <p>排名需要用到的、处理后的数据。这些数据比较独立，故单独做表存储之。目前包括论文引用胜者、国际论文引用胜者、国内论文引用胜者、标准薪酬、录取分数线。</p> <h3 id="sch-report-data-gbbk-gzgz"><a href="#sch-report-data-gbbk-gzgz" class="header-anchor">#</a> sch_report_data_gbbk_gzgz</h3> <p>公办本科和高职高专的《就业质量报告》数据。由于公办和民办大学有的会重叠，所以这两份数据分开存储。对于早前的数据，date统一为发布年年底（如202312）</p> <h3 id="sch-report-data-mbdy"><a href="#sch-report-data-mbdy" class="header-anchor">#</a> sch_report_data_mbdy</h3> <p>民办独院的《就业质量报告》数据。</p> <h3 id="school-major-b-2"><a href="#school-major-b-2" class="header-anchor">#</a> school_major_b</h3> <p>最终用于计算科研得分的公办民办本科学校专业开设情况。</p> <h3 id="school-major-z"><a href="#school-major-z" class="header-anchor">#</a> school_major_z</h3> <p>最终用于计算科研得分的职专学校专业开设情况。</p> <h2 id="h区表格介绍"><a href="#h区表格介绍" class="header-anchor">#</a> H区表格介绍</h2> <p>H区表格包含其他区表格的全部字段，只是多出change_at、change_type两个字段。change_at为更新时的时间戳，change_type为INSERT/UPDATE/DELETE。
<code>research类</code>表格由于体积过大，一般不予备份。</p> <h2 id="i区表格介绍"><a href="#i区表格介绍" class="header-anchor">#</a> I区表格介绍</h2> <h3 id="book-info"><a href="#book-info" class="header-anchor">#</a> book_info</h3> <p>著作信息。存储<code>long_id</code>和<code>full_name</code>字段。</p> <h3 id="competition-and-party-info"><a href="#competition-and-party-info" class="header-anchor">#</a> competition_and_party_info</h3> <p>党建思政和学生竞赛信息。</p> <details class="custom-block details"><summary>字段说明</summary> <p>long_id : 编号，与C区表相匹配。</p> <p>project_name：参考<code>【1125定稿】竞赛名与赛道组别对照表.xlsx</code>。</p> <p>competition_level：获奖级别，如一等奖、（经费资助）20w、全国党建工作示范高校等等。</p> <p>original_yr：所采集到的原始年份。有时为区间，如2020-2022。</p> <p>details: 项目的名称、内容等。</p> <p>original_org：部分职专院校的原始采集到的名称，根据陈艺滨的要求予以保留。</p></details> <h3 id="jiangxiang-info"><a href="#jiangxiang-info" class="header-anchor">#</a> jiangxiang_info</h3> <p>奖项信息。存储<code>long_id</code>、<code>项目名称</code>、<code>获奖等级</code>、<code>完成单位总数</code>、<code>完成单位顺序</code>字段。</p> <div class="custom-block warning"><p class="custom-block-title">todo_待决策事项</p> <p>原始采集到的奖项比实际用的奖项多出不少。二者的差主要是那些暂不参与排名的机构（如公司、研究所等）的数据。
未来是否有可能用到这部分数据？是否需要将之存储在此表中？（也就是说，今后jiangxiang_info可能比C区表格条数更多，并且具有完整字段）。</p> <p>暂时的处理方案是不予存储。</p></div> <h3 id="paper-info"><a href="#paper-info" class="header-anchor">#</a> paper_info</h3> <p>论文信息。</p> <div class="custom-block tip"><p class="custom-block-title">作者单位数与顺序</p> <p>这里未记录作者单位数与顺序。可以根据C区表格的<code>basic_score</code>逆推。</p></div> <details class="custom-block details"><summary>字段说明</summary> <p>long_id：论文对照号。</p> <p>full_name：论文题目。</p> <p>journal：期刊。</p> <p>organAll：原始作者单位。</p></details> <h3 id="patent-info"><a href="#patent-info" class="header-anchor">#</a> patent_info</h3> <p>专利信息。存储字段<code>long_id</code>、<code>full_name</code>、<code>unit_order</code>、<code>unit_number</code></p> <h2 id="m区表格介绍"><a href="#m区表格介绍" class="header-anchor">#</a> M区表格介绍</h2> <div class="custom-block tip"><p class="custom-block-title">建设中...</p> <p>M区表格正在建设中，请以最新建设情况为准。</p></div> <p>应当包含3张表，分别用以存储按照专业类、专业门类、研究生学科类等计算得到的科研得分。</p> <p>应当包含1张表，用以存储党建竞赛的得分。</p> <p>应当包含1张表，用以分院校-学科存储科研细项（发明专利、英文他引得分等等）。</p> <p>应当包含1张表，用以存储各项原始数据本次排名计算周期、本周期（如本月）、上周期三个阶段的原始数据数量（增量）。</p> <h2 id="o区表格介绍"><a href="#o区表格介绍" class="header-anchor">#</a> O区表格介绍</h2> <h3 id="config-table"><a href="#config-table" class="header-anchor">#</a> config_table</h3> <p>决定局部备份是否开启</p> <h3 id="readme"><a href="#readme" class="header-anchor">#</a> _readme_</h3> <p>决定在数据库管理器上所显示的表格别名。</p> <h3 id="table-update-time"><a href="#table-update-time" class="header-anchor">#</a> table_update_time</h3> <p>记录各表格的最后更新时间。一般由trigger自动生成。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8 months ago</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/func/assets/js/app.25566812.js" defer></script><script src="/func/assets/js/2.cfd2aafd.js" defer></script><script src="/func/assets/js/1.959a7dda.js" defer></script><script src="/func/assets/js/23.3ebb0e0e.js" defer></script><script src="/func/assets/js/4.4f3ff79f.js" defer></script><script src="/func/assets/js/18.8d0a14c5.js" defer></script>
  </body>
</html>
