<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库文档 | 林祥子的文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/func/logo.svg">
    <link rel="manifest" href="/func/manifest.json">
    <link rel="apple-touch-icon" href="/func/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/func/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="基于Vuepress的功能部博客">
    <meta name="author" content="func">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/func/assets/css/0.styles.94edebd6.css" as="style"><link rel="preload" href="/func/assets/js/app.25566812.js" as="script"><link rel="preload" href="/func/assets/js/2.cfd2aafd.js" as="script"><link rel="preload" href="/func/assets/js/1.959a7dda.js" as="script"><link rel="preload" href="/func/assets/js/24.d3d3c175.js" as="script"><link rel="preload" href="/func/assets/js/18.8d0a14c5.js" as="script"><link rel="prefetch" href="/func/assets/js/10.d1f8a545.js"><link rel="prefetch" href="/func/assets/js/11.83ee45e6.js"><link rel="prefetch" href="/func/assets/js/12.5aa091df.js"><link rel="prefetch" href="/func/assets/js/13.61f6c833.js"><link rel="prefetch" href="/func/assets/js/14.d8e1b48e.js"><link rel="prefetch" href="/func/assets/js/15.a889dc1b.js"><link rel="prefetch" href="/func/assets/js/16.291ac9d9.js"><link rel="prefetch" href="/func/assets/js/17.d6183440.js"><link rel="prefetch" href="/func/assets/js/19.f098136a.js"><link rel="prefetch" href="/func/assets/js/20.c7157ec1.js"><link rel="prefetch" href="/func/assets/js/21.974e2450.js"><link rel="prefetch" href="/func/assets/js/22.7a8b72fa.js"><link rel="prefetch" href="/func/assets/js/23.3ebb0e0e.js"><link rel="prefetch" href="/func/assets/js/25.3b0d5f0d.js"><link rel="prefetch" href="/func/assets/js/26.5696957f.js"><link rel="prefetch" href="/func/assets/js/27.aef0f6ec.js"><link rel="prefetch" href="/func/assets/js/28.3bddc70c.js"><link rel="prefetch" href="/func/assets/js/29.d384c07a.js"><link rel="prefetch" href="/func/assets/js/3.799f8d22.js"><link rel="prefetch" href="/func/assets/js/30.69c0d040.js"><link rel="prefetch" href="/func/assets/js/31.fb2b3451.js"><link rel="prefetch" href="/func/assets/js/32.e75403f7.js"><link rel="prefetch" href="/func/assets/js/33.cbb42dbf.js"><link rel="prefetch" href="/func/assets/js/34.06d3621c.js"><link rel="prefetch" href="/func/assets/js/35.340600fa.js"><link rel="prefetch" href="/func/assets/js/36.2dd16318.js"><link rel="prefetch" href="/func/assets/js/37.65d1c612.js"><link rel="prefetch" href="/func/assets/js/38.a6667f32.js"><link rel="prefetch" href="/func/assets/js/39.91718eec.js"><link rel="prefetch" href="/func/assets/js/4.4f3ff79f.js"><link rel="prefetch" href="/func/assets/js/40.f40ff10b.js"><link rel="prefetch" href="/func/assets/js/41.36a8e38b.js"><link rel="prefetch" href="/func/assets/js/42.db11803e.js"><link rel="prefetch" href="/func/assets/js/43.516090da.js"><link rel="prefetch" href="/func/assets/js/44.9470a868.js"><link rel="prefetch" href="/func/assets/js/45.fd60a124.js"><link rel="prefetch" href="/func/assets/js/46.9b7d7cc2.js"><link rel="prefetch" href="/func/assets/js/47.69dd2a8d.js"><link rel="prefetch" href="/func/assets/js/48.d6f4eaad.js"><link rel="prefetch" href="/func/assets/js/49.18b4f8ea.js"><link rel="prefetch" href="/func/assets/js/5.b4cb2a6c.js"><link rel="prefetch" href="/func/assets/js/50.874af25a.js"><link rel="prefetch" href="/func/assets/js/51.9b99ccc6.js"><link rel="prefetch" href="/func/assets/js/52.aa933f9d.js"><link rel="prefetch" href="/func/assets/js/53.1495fec9.js"><link rel="prefetch" href="/func/assets/js/54.dd66def3.js"><link rel="prefetch" href="/func/assets/js/55.bfcf65ed.js"><link rel="prefetch" href="/func/assets/js/56.1515f411.js"><link rel="prefetch" href="/func/assets/js/57.5aa62846.js"><link rel="prefetch" href="/func/assets/js/58.db55929e.js"><link rel="prefetch" href="/func/assets/js/59.8f6f45a4.js"><link rel="prefetch" href="/func/assets/js/60.bb6f054d.js"><link rel="prefetch" href="/func/assets/js/61.c8602e95.js"><link rel="prefetch" href="/func/assets/js/62.94ac2c96.js"><link rel="prefetch" href="/func/assets/js/63.6775b986.js"><link rel="prefetch" href="/func/assets/js/64.c33bc1e9.js"><link rel="prefetch" href="/func/assets/js/8.bcd7b08f.js"><link rel="prefetch" href="/func/assets/js/9.fb5567ee.js"><link rel="prefetch" href="/func/assets/js/vendors~docsearch.992c13e1.js">
    <link rel="stylesheet" href="/func/assets/css/0.styles.94edebd6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/func/" class="home-link router-link-active"><!----> <span class="site-name">林祥子的文档</span></a> <div class="links"><div class="pictureSwitchBox"><img src="/func/pictureOn.svg"></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/func/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          会议记录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/func/lin/session1.html" class="nav-link">
  第一次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session2.html" class="nav-link">
  第二次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session3.html" class="nav-link">
  第三次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session4.html" class="nav-link">
  第四次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session5.html" class="nav-link">
  第五次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session6.html" class="nav-link">
  第六次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session7.html" class="nav-link">
  第七次晚自习
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的记录" class="dropdown-title"><span class="title">我的记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/func/lin/reportDevDoc.html" class="nav-link">
  咨询报告开发文档
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/rhj1.html" class="nav-link">
  任鸿隽教育思想
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/spssMaps.html" class="nav-link">
  SPSS学习目录
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/func/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="游戏开发" class="dropdown-title"><span class="title">游戏开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          会议记录
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/func/lin/session1.html" class="nav-link">
  第一次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session2.html" class="nav-link">
  第二次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session3.html" class="nav-link">
  第三次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session4.html" class="nav-link">
  第四次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session5.html" class="nav-link">
  第五次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session6.html" class="nav-link">
  第六次晚自习
</a></li><li class="dropdown-subitem"><a href="/func/lin/session7.html" class="nav-link">
  第七次晚自习
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的记录" class="dropdown-title"><span class="title">我的记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/func/lin/reportDevDoc.html" class="nav-link">
  咨询报告开发文档
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/rhj1.html" class="nav-link">
  任鸿隽教育思想
</a></li><li class="dropdown-item"><!----> <a href="/func/lin/spssMaps.html" class="nav-link">
  SPSS学习目录
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库文档</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/func/lin/DBdoc_v2.html#一、数据库结构" class="sidebar-link">一、数据库结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/func/lin/DBdoc_v2.html#二、分模块介绍表结构" class="sidebar-link">二、分模块介绍表结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/func/lin/DBdoc_v2.html#用户-学校-权限" class="sidebar-link">用户-学校-权限</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc_v2.html#原始数据" class="sidebar-link">原始数据</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc_v2.html#胜者排名" class="sidebar-link">胜者排名</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc_v2.html#核心功能" class="sidebar-link">核心功能</a></li><li class="sidebar-sub-header"><a href="/func/lin/DBdoc_v2.html#工单、新闻、咨询" class="sidebar-link">工单、新闻、咨询</a></li></ul></li><li><a href="/func/lin/DBdoc_v2.html#备份功能代码" class="sidebar-link">备份功能代码</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库文档"><a href="#数据库文档" class="header-anchor">#</a> 数据库文档</h1> <div class="custom-block tip"><p class="custom-block-title">小贴士</p> <p>目前已可局域网访问。暂时无法在公网访问。</p></div> <h2 id="一、数据库结构"><a href="#一、数据库结构" class="header-anchor">#</a> 一、数据库结构</h2> <p><img src="/func/assets/img/db_v2.acd34e13.png" alt="总数据"></p> <ul><li>原始数据：存放艺术，奖励，专著，专利等底层数据，与elasticsearch中的数据相同。</li> <li>工单、新闻、咨询：管理用户工单、咨询申请和新闻信息，实现客户问题的跟踪处理和资讯发布功能。</li> <li>胜者排名：本模块主要用于存放胜者排名，分为国际和国内，分析全球高校间的论文互引关系。</li> <li>核心功能：主要用户沙盘推演，以及当前名次解析等</li> <li>用户-学校-权限：主要用于用户认证、权限控制和学校基本数据存储。</li></ul> <details class="custom-block details"><summary>各表中long_id的编写规范</summary> <p>对于已有唯一号的，均予以保留。</p> <p>未统一编号的，所使用的long_id形如B24111903002492。</p> <ul><li>第1位B（公办）本科/M民办本科/Z高职高专与职业大学，区分公办民办本科和职专（B有时会指公办民办本科，M不单列）。</li> <li>2-7位填上传日期。</li> <li>8-9位填上传时的领域，例如有10种不同竞赛，那么这两位可以依次填01-10，只要与本地文件保持一直即可。</li> <li>10-15位填递增序号。</li></ul></details> <h2 id="二、分模块介绍表结构"><a href="#二、分模块介绍表结构" class="header-anchor">#</a> 二、分模块介绍表结构</h2> <h3 id="用户-学校-权限"><a href="#用户-学校-权限" class="header-anchor">#</a> 用户-学校-权限</h3> <div class="custom-block tip"><p class="custom-block-title">表间联系</p> <ol><li><code>users</code>通过<code>groups_id</code>关联<code>user_group</code></li> <li><code>user_group_permissions</code>作为中间表连接<code>user_group</code>和<code>user_permission</code></li> <li><code>school_mapping</code>和<code>school_data</code>通过<code>school_data_id</code>和<code>school_mapping_id</code>相互关联</li> <li>通过<code>school_mapping</code>设置学校层面的权限和对比校</li></ol></div> <h4 id="表结构说明"><a href="#表结构说明" class="header-anchor">#</a> 表结构说明</h4> <details class="custom-block details"><summary>users (用户表)</summary> <ul><li><code>id</code>: 自增主键</li> <li><code>user_id</code>: cookie记录的用户ID</li> <li><code>username</code>: 登录用户名(唯一)</li> <li><code>password</code>: SHA256哈希密码</li> <li><code>sch_code</code>: 关联学校编码</li> <li><code>created_at</code>: 创建时间</li> <li><code>last_login</code>: 最后登录时间</li> <li><code>email</code>: 邮箱</li> <li><code>login_attempts</code>: 连续登录失败次数</li> <li><code>account_locked_until</code>: 账户锁定截止时间</li> <li><code>last_failed_attempt</code>: 最后失败登录时间</li> <li><code>salt</code>: 静态salt</li> <li><code>is_active</code>: 是否激活</li> <li><code>is_anonymous</code>: 是否匿名用户(废弃)</li> <li><code>is_authenticated</code>: 是否认证</li> <li><code>is_superuser</code>: 是否为超级用户</li> <li><code>is_staff</code>: 是否为管理员</li> <li><code>groups_id</code>: 权限组ID</li></ul></details> <details class="custom-block details"><summary>user_permission (权限表)</summary> <ul><li><code>id</code>: 自增ID</li> <li><code>api_url</code>: API接口URL</li> <li><code>parameter</code>: 参数名称</li> <li><code>data</code>: 参数值</li> <li><code>method</code>: 发送方式</li></ul></details> <details class="custom-block details"><summary>user_group_permissions (权限组-权限中间表)</summary> <ul><li><code>id</code>: 自增ID</li> <li><code>usergroup_id</code>: 权限组ID</li> <li><code>userpermission_id</code>: 权限ID</li></ul></details> <details class="custom-block details"><summary>user_group (用户权限组表)</summary> <ul><li><code>id</code>: 自增ID</li> <li><code>permission_group_name</code>: 权限组名称</li></ul></details> <details class="custom-block details"><summary>school_mapping (学校权限表)</summary> <ul><li><code>id</code>: 自增ID</li> <li><code>sch_code</code>: 学科code</li> <li><code>sch_name</code>: 学校名称</li> <li><code>compare_sch_name</code>: 对比校</li> <li><code>school_data_id</code>: 学校信息ID</li> <li><code>can_view_all_compare</code>: 是否可查看所有对比学校</li> <li><code>can_search_full</code>: 是否有全库查找权限</li></ul></details> <details class="custom-block details"><summary>school_data (学校基本信息表)</summary> <ul><li><code>rank</code>: 综合实力排名</li> <li><code>sch_name</code>: 学校名称</li> <li><code>province</code>: 省份</li> <li><code>location</code>: 所在地</li> <li><code>reference_type</code>: 学校参考类型</li> <li><code>broad_categor</code>: 学校参考类</li> <li><code>detailed_reference_type</code>: 学校细分参考型</li> <li><code>reference_model</code>: 学校参考型</li> <li><code>top_university</code>: 中国一流大学</li> <li><code>is_double_first_class</code>: 双一流</li> <li><code>city</code>: 城市</li> <li><code>id</code>: 自增ID</li> <li><code>school_mapping_id</code>: 学校权限表ID</li> <li><code>sch_en_name</code>: 学校英文名</li> <li><code>is_985</code>: 是否为985</li> <li><code>is_211</code>: 是否为211</li> <li><code>main_department</code>: 主管部门</li> <li><code>sch_type_detail</code>: 学校类型</li></ul></details> <details class="custom-block details"><summary>django_session (会话表)</summary> <ul><li><code>session_key</code>: 会话键</li> <li><code>session_data</code>: 会话数据</li> <li><code>create_date</code>: 创建时间</li> <li><code>expire_date</code>: 失效时间</li> <li><code>user_id</code>: 用户ID</li> <li><code>salt</code>: 动态salt</li></ul></details> <h3 id="原始数据"><a href="#原始数据" class="header-anchor">#</a> 原始数据</h3> <h4 id="表间联系"><a href="#表间联系" class="header-anchor">#</a> 表间联系</h4> <p>所有表通过<code>sch_name</code>(学校名称)字段关联</p> <h4 id="表结构说明-2"><a href="#表结构说明-2" class="header-anchor">#</a> 表结构说明</h4> <details class="custom-block details"><summary>patent_res (专利表)</summary> <ul><li><code>long_id</code>: 唯一号</li> <li><code>full_name</code>: 中文题名</li> <li><code>sch_name</code>: 最终校名</li> <li><code>unit_number</code>: 单位总数</li> <li><code>unit_order</code>: 单位顺序</li> <li><code>patent_type</code>: 专利类型</li> <li><code>writer</code>: 发明(设计)人</li> <li><code>authorization</code>: 授权</li> <li><code>transfer</code>: 转移</li> <li><code>license</code>: 许可</li> <li><code>year</code>: 授权年份</li> <li><code>final_score</code>: 最终得分</li> <li><code>basic_score</code>: 基础得分</li> <li><code>id</code>: 自增ID</li> <li><code>source_db</code>: 来源数据库</li></ul></details> <details class="custom-block details"><summary>book_res (专著表)</summary> <ul><li><code>id</code>: 自增ID</li> <li><code>long_id</code>: 匹配编号</li> <li><code>book_type</code>: 库别</li> <li><code>full_name</code>: 著作名</li> <li><code>writer</code>: 完成人</li> <li><code>year</code>: 年份</li> <li><code>sch_name</code>: 最终校名</li> <li><code>publisher</code>: 出版社</li> <li><code>final_score</code>: 最终得分</li> <li><code>basic_score</code>: 基础得分</li> <li><code>unit_number</code>: 完成单位总数</li> <li><code>unit_order</code>: 完成单位顺序</li> <li><code>total_citation_count</code>: 引用次数</li> <li><code>source_db</code>: 数据库来源</li></ul></details> <details class="custom-block details"><summary>award_res (奖项表)</summary> <ul><li><code>id</code>: 自增ID</li> <li><code>long_id</code>: 匹配编号</li> <li><code>awardaffiliation</code>: 奖属</li> <li><code>full_name</code>: 项目名称</li> <li><code>writer</code>: 完成人</li> <li><code>year</code>: 年份</li> <li><code>sch_name</code>: 最终校名</li> <li><code>category</code>: 获奖类别</li> <li><code>award_level</code>: 获奖等级</li> <li><code>final_score</code>: 最终得分</li> <li><code>basic_score</code>: 基础得分</li> <li><code>unit_number</code>: 完成单位总数</li> <li><code>unit_order</code>: 完成单位顺序</li> <li><code>org_name</code>: 学院</li> <li><code>source_db</code>: 来源数据库</li></ul></details> <details class="custom-block details"><summary>artistic_res (艺术作品表)</summary> <ul><li><code>long_id</code>: 唯一ID</li> <li><code>type</code>: 获奖类型</li> <li><code>category</code>: 获奖来源类别</li> <li><code>award_level</code>: 获奖等级</li> <li><code>full_name</code>: 项目名称</li> <li><code>unit_order</code>: 单位排名</li> <li><code>unit_number</code>: 单位总数</li> <li><code>final_score</code>: 最终得分</li> <li><code>sch_name</code>: 学校名称</li> <li><code>source_db</code>: 来源数据库</li> <li><code>sch_type</code>: 学校类型</li> <li><code>second_kind</code>: 专业类</li> <li><code>writer</code>: 获奖人</li> <li><code>award_type</code>: 艺术类型</li> <li><code>id</code>: 自增ID</li> <li><code>year</code>: 年份</li></ul></details> <h3 id="胜者排名"><a href="#胜者排名" class="header-anchor">#</a> 胜者排名</h3> <div class="custom-block tip"><p class="custom-block-title">表间联系</p> <ol><li><code>cite_rank_score_en</code>和<code>cite_rank_score_cn</code>提供排名得分标准</li> <li><code>cite_en_rank</code>和<code>cite_cn</code>分别记录国际和国内高校引用数据</li> <li><code>cite_all</code>汇总全球高校对比结果</li> <li><code>cite_adjust_rank_en</code>和<code>cite_adjust_rank_cn</code>存储调整后的排名结果</li></ol></div> <h4 id="表结构说明-3"><a href="#表结构说明-3" class="header-anchor">#</a> 表结构说明</h4> <details class="custom-block details"><summary>cite_rank_score_en (国际胜者排名得分表)</summary> <p><strong>说明</strong>：每个排名对应得多少分</p> <ul><li><code>rank</code>: 胜者排名(主键)</li> <li><code>rank_score</code>: 胜者排名分</li> <li><code>cite_score</code>: 国际论文引用胜者归一得分</li></ul></details> <details class="custom-block details"><summary>cite_rank_score_cn (国内胜者排名得分表)</summary> <p><strong>说明</strong>：每个排名对应得多少分</p> <ul><li><code>rank</code>: 胜者排名(主键)</li> <li><code>rank_score</code>: 胜者排名分</li> <li><code>cite_score</code>: 国内论文引用胜者归一得分</li></ul></details> <details class="custom-block details"><summary>cite_en_rank (国际高校引用排名表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>sch_name</code>: 大学名称</li> <li><code>cite_count</code>: 被引量</li> <li><code>rank</code>: 排名</li></ul></details> <details class="custom-block details"><summary>cite_cn (国内高校引用对比表)</summary> <p>说明：所有高校之间的论文引用胜者胜负情况</p> <ul><li><code>id</code>: ID(主键)</li> <li><code>sch_name</code>: 学校名称</li> <li><code>compare_sch</code>: 对比校</li> <li><code>win</code>: 是否赢</li> <li><code>lose</code>: 是否输</li> <li><code>draw</code>: 是否平</li> <li><code>empty</code>: 是否无引用</li> <li><code>cite_scd</code>: 本校对对比校的scd引用量</li> <li><code>cite_scdw</code>: 本校对对比校的scdw引用量</li></ul></details> <details class="custom-block details"><summary>cite_all (全球高校引用对比汇总表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>sch_name</code>: 学校名称</li> <li><code>sch_country</code>: 学校所在国家</li> <li><code>compare_country</code>: 对比大洲</li> <li><code>sch_num</code>: 学校所在国家的数量</li> <li><code>win</code>: 赢了多少学校</li> <li><code>lose</code>: 输了多少学校</li> <li><code>win_rate</code>: 赢的比例</li> <li><code>draw</code>: 平局数</li> <li><code>empty</code>: 胜负差值(win-lose)</li> <li><code>diff</code>: 无引用情况</li> <li><code>continent</code>: 大洲</li></ul></details> <details class="custom-block details"><summary>cite_adjust_rank_en (国际调整后排名表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>sch_name</code>: 校名</li> <li><code>adjust_rate</code>: 引用量调整比例</li> <li><code>adjust_rank</code>: 调整后SCDW胜者排名</li></ul></details> <details class="custom-block details"><summary>cite_adjust_rank_cn (国内调整后排名表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>sch_name</code>: 校名</li> <li><code>adjust_rate</code>: 引用量调整比例</li> <li><code>adjust_rank</code>: 调整后SCD胜者排名</li></ul></details> <h3 id="核心功能"><a href="#核心功能" class="header-anchor">#</a> 核心功能</h3> <div class="custom-block tip"><p class="custom-block-title">表间联系</p> <ol><li><code>research_jiangxiang_25</code>和<code>research_25</code>存储核心科研成果数据</li> <li><code>raw_data_time_range_25</code>和<code>raw_data_middle_25</code>提供竞赛数据支持</li> <li><code>dynamicrank</code>表整合各类指标生成动态排名</li> <li><code>group</code>表管理用户自定义学校分组</li></ol></div> <h4 id="表结构说明-4"><a href="#表结构说明-4" class="header-anchor">#</a> 表结构说明</h4> <p><strong>特别注意</strong>:计算本科科研得分时，须使用调整过的最终概率作为probability_all_in_one。此处应当跟子谦确认。</p> <details class="custom-block details"><summary>research_jiangxiang_25 (奖励数据表)</summary> <p><strong>说明</strong>：存放奖项数据</p> <ul><li><code>long_id</code>: 唯一ID(主键)</li> <li><code>date</code>: 年份</li> <li><code>sch_name</code>: 学校名称</li> <li><code>basic_score</code>: 基础分数</li> <li><code>final_score</code>: 最终分数</li> <li><code>probability_all_in_one</code>: 属于学科类的概率</li> <li><code>from_db</code>: 数据库来源</li> <li><code>type</code>: 类型</li> <li><code>sch_type</code>: 学校类型</li> <li><code>category</code>: 奖励类别</li></ul></details> <details class="custom-block details"><summary>research_25 (综合科研成果表)</summary> <p><strong>说明</strong>：存放除奖项外，其他如竞赛，论文，专著、艺术，思政、专利等基础数据</p> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>long_id</code>: 唯一ID</li> <li><code>date</code>: 年份</li> <li><code>sch_name</code>: 学校名称</li> <li><code>basic_score</code>: 基础得分</li> <li><code>final_score</code>: 最终得分</li> <li><code>probability_all_in_one</code>: 属于学科类的概率</li> <li><code>from_db</code>: 数据来源</li> <li><code>type</code>: 类型</li> <li><code>sch_type</code>: 学校类型</li></ul></details> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>使用research_25表计算本科科研得分时，须使用调整过的最终概率作为probability_all_in_one。此处应当跟子谦确认。</p></div> <details class="custom-block details"><summary>raw_data_time_range_25 (本校排名数据库表)</summary> <p>说明：本张表用于网站的本校排名数据模块</p> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>category</code>: 类别</li> <li><code>name</code>:名称</li> <li><code>sub_project</code>: 项目</li> <li><code>max_date</code>: 最大时间</li> <li><code>min_date</code>: 最小时间</li> <li><code>update_time</code>: 更新时间</li> <li><code>sch_type</code>: 学校类型</li> <li><code>sch_type_detail</code>: 学校类型详情</li></ul></details> <details class="custom-block details"><summary>raw_data_middle_25 (本校排名数据库总数表)</summary> <p>说明：本张表用于生成网站的本校排名数据模块的原始数据/总条数即（<code>total_SUM</code>字段），更加方便</p> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>sch_name</code>: 学校名称</li> <li><code>category</code>: 类别</li> <li><code>name</code>: 名称</li> <li><code>sub_project</code>: 项目名称</li> <li><code>total_SUM</code>: 获奖总数</li> <li><code>CURRENT_SUM</code>: 本次获奖数</li> <li><code>LAST_SUM</code>: 上次获奖数</li> <li><code>update_time</code>: 更新时间</li> <li><code>sum_first_order</code>: 第一获奖单位次数</li> <li><code>sch_type_detail</code>: 学校种类</li></ul></details> <details class="custom-block details"><summary>jiangxiang_info_25 (奖项详情表)</summary> <ul><li><code>long_id</code>: 唯一ID</li> <li><code>项目名称</code>: 项目名称</li> <li><code>获奖等级</code>: 获奖等级</li> <li><code>完成单位总数</code>: 完成单位总数</li> <li><code>完成单位顺序</code>: 完成单位顺序</li></ul></details> <details class="custom-block details"><summary>group (学校分组表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>school_mapping_id</code>: 学校权限表ID</li> <li><code>group_school_id</code>: 学校组ID</li> <li><code>selection_order</code>: 排名</li> <li><code>user_id</code>: 用户ID</li> <li><code>name</code>: 学校组名称</li></ul></details> <details class="custom-block details"><summary>dynamicrank (动态排名表)</summary> <p><strong>说明</strong>：当前名次模块数据均由本表提供</p> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>sch_name</code>: 校名</li> <li><code>StrengthRank</code>: 综合实力排名</li> <li><code>Strength</code>: 综合实力得分</li> <li><code>UndergraduateEmploymentQuality</code>: 本科生就业质量</li> <li><code>UndergraduateEmploymentQualityRank</code>: 本科生就业质量排名</li> <li><code>ScoreLine</code>: 录取分数线</li> <li><code>ScoreLineRank</code>: 录取分数线排名</li> <li><code>FacultyAcademicLevel</code>: 教师学术水平</li> <li><code>FacultyAcademicLevelRank</code>: 教师学术水平排名</li> <li><code>SelectionScore</code>: 择校顺序得分</li> <li><code>SelectionScoreRank</code>: 择校顺序排名</li> <li><code>PoliticalNormalization</code>: 党建思政得分</li> <li><code>PoliticalNormalizationRank</code>: 党建思政排名</li> <li><code>AdvancementRate</code>: 升学率</li> <li><code>AdvancementRateRank</code>: 升学率排名</li> <li><code>CompetitionNormalization</code>: 学生竞赛得分</li> <li><code>CompetitionNormalizationRank</code>: 学生竞赛排名</li> <li><code>CostEffectivenessNormalization</code>: 性价比得分</li> <li><code>CostEffectivenessNormalizationRank</code>: 性价比排名</li> <li><code>ScientificResearch</code>: 科学研究得分</li> <li><code>ScientificResearchRank</code>: 科学研究排名</li> <li><code>PaperCitationWinner</code>: 论文引用胜者得分</li> <li><code>PaperCitationWinnerRank</code>: 论文引用胜者排名</li> <li><code>year</code>: 年份</li> <li><code>school_data_id</code>: 学校数据ID</li> <li><code>UndergraduateTraining</code>: 本科生培养得分</li> <li><code>UndergraduateTrainingRank</code>: 本科生培养排名</li> <li><code>PostgraduateTraining</code>: 研究生培养得分</li> <li><code>PostgraduateTrainingRank</code>: 研究生培养排名</li> <li><code>NaturalScienceResearch</code>: 自然科学研究得分</li> <li><code>NaturalScienceResearchRank</code>: 自然科学研究排名</li> <li><code>SocialScienceResearch</code>: 社会科学研究得分</li> <li><code>SocialScienceResearchRank</code>: 社会科学研究排名</li></ul></details> <details class="custom-block details"><summary>competition_and_party_25 (竞赛与思政表)</summary> <p><strong>说明</strong>：包含本科、民办、职专的所有党建、思政、各种学生竞赛数据。为保证入库时结构统一，已按照<code>【1125定稿】竞赛名与赛道组别对照表.xlsx</code>重新梳理了所有竞赛的名称</p> <ul><li><code>long_id</code>: 唯一ID(主键)</li> <li><code>category</code>: 竞赛类别</li> <li><code>competition_name</code>: 竞赛名称</li> <li><code>project_name</code>: 项目名称</li> <li><code>sub_project</code>: 竞赛具体信息</li> <li><code>competition_level</code>: 获奖等级</li> <li><code>sch_name</code>: 学校名称</li> <li><code>score</code>: 得分</li> <li><code>details</code>: 详细信息</li> <li><code>end_year</code>: 获奖时间</li> <li><code>sch_type</code>: 学校类型</li></ul></details> <h3 id="工单、新闻、咨询"><a href="#工单、新闻、咨询" class="header-anchor">#</a> 工单、新闻、咨询</h3> <h4 id="表间联系-2"><a href="#表间联系-2" class="header-anchor">#</a> 表间联系</h4> <ol><li><code>ticket</code>和<code>ticket_followup</code>通过<code>ticket_id</code>关联，形成工单与追问的1对多关系</li> <li>其他表之间没有直接外键关联，属于功能独立的模块</li></ol> <h4 id="表结构说明-5"><a href="#表结构说明-5" class="header-anchor">#</a> 表结构说明</h4> <details class="custom-block details"><summary>ticket_followup (工单追问表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>description</code>: 问题描述</li> <li><code>user_id</code>: 关联用户ID</li> <li><code>created_at</code>: 创建时间</li> <li><code>resolved_at</code>: 回复时间</li> <li><code>update_at</code>: 修改时间</li> <li><code>delete_at</code>: 删除时间</li> <li><code>status</code>: 状态(默认'待处理')</li> <li><code>resolution</code>: 回复内容</li> <li><code>ticket_id</code>: 关联工单ID</li> <li><code>attachment1</code>: 用户附件路径1</li> <li><code>attachment2</code>: 用户附件路径2</li> <li><code>admin_attachment1</code>: 客服附件1</li> <li><code>admin_attachment2</code>: 客服附件2</li> <li><code>ticketfollowup_id</code>: 追问工单ID(用于关联追问链)</li></ul></details> <details class="custom-block details"><summary>ticket (工单主表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>module</code>: 问题模块</li> <li><code>description</code>: 问题描述</li> <li><code>status</code>: 工单状态(默认'pending')</li> <li><code>created_at</code>: 创建时间</li> <li><code>resolved_at</code>: 回复时间</li> <li><code>resolution</code>: 处理结果</li> <li><code>user_id</code>: 用户ID</li> <li><code>delete_at</code>: 删除时间</li> <li><code>title</code>: 工单标题</li> <li><code>kind</code>: 问题种类</li> <li><code>phone</code>: 联系电话</li> <li><code>is_read</code>: 是否已读</li> <li><code>follow_ups</code>: 废弃字段(原追问工单ID)</li> <li><code>ticket_id</code>: 工单编号</li> <li><code>update_at</code>: 修改时间</li> <li><code>attachment1</code>: 用户附件路径1</li> <li><code>attachment2</code>: 用户附件路径2</li> <li><code>admin_attachment1</code>: 客服附件1</li> <li><code>admin_attachment2</code>: 客服附件2</li></ul></details> <details class="custom-block details"><summary>submit_application (咨询申请表)</summary> <ul><li><code>id</code>: 自增ID(主键)</li> <li><code>institution</code>: 单位名称</li> <li><code>phone</code>: 联系电话</li> <li><code>email</code>: 电子邮箱</li> <li><code>name</code>: 联系人姓名</li> <li><code>message</code>: 咨询信息</li> <li><code>create_time</code>: 创建时间</li> <li><code>ip_address</code>: IP地址</li></ul></details> <details class="custom-block details"><summary>information (新闻资讯表)</summary> <ul><li><code>title</code>: 新闻标题</li> <li><code>id</code>: 记录ID</li> <li><code>url</code>: 新闻链接URL</li></ul></details> <h2 id="备份功能代码"><a href="#备份功能代码" class="header-anchor">#</a> 备份功能代码</h2> <p>用于创建副表和触发器，及时记录（即局部备份）每项改动。</p> <details class="custom-block details"><summary>代码实现</summary> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> mysql<span class="token punctuation">.</span>connector
<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> closing
<span class="token keyword">import</span> re

<span class="token comment"># MySQL 连接参数</span>
db_config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'host'</span><span class="token punctuation">:</span> <span class="token string">'192.168.0.91'</span><span class="token punctuation">,</span>
    <span class="token string">'user'</span><span class="token punctuation">:</span> <span class="token string">'wu'</span><span class="token punctuation">,</span>
    <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'xZ7FwtAD5HnhajxJ'</span><span class="token punctuation">,</span>
    <span class="token string">'database'</span><span class="token punctuation">:</span> <span class="token string">'wurank'</span><span class="token punctuation">,</span>
    <span class="token string">'charset'</span><span class="token punctuation">:</span> <span class="token string">'utf8mb4'</span>  <span class="token comment"># 设置字符集</span>
<span class="token punctuation">}</span>


<span class="token comment"># 获取表的列名</span>
<span class="token keyword">def</span> <span class="token function">get_columns</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;SHOW COLUMNS FROM `</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">`&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>column<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> column <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># 删除历史表（如果存在）</span>
<span class="token keyword">def</span> <span class="token function">drop_history_table_if_exists</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    history_table <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_history&quot;</span></span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;SHOW TABLES LIKE '</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">'&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;History table </span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string"> already exists. Dropping it.&quot;</span></span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;DROP TABLE IF EXISTS `</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">`&quot;</span></span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 创建历史表</span>
<span class="token keyword">def</span> <span class="token function">create_history_table</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    columns <span class="token operator">=</span> get_columns<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
    history_table <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_history&quot;</span></span>
    columns_definition <span class="token operator">=</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;`</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">` VARCHAR(255)&quot;</span></span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns<span class="token punctuation">]</span><span class="token punctuation">)</span>
    history_table_sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;
    CREATE TABLE `</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">` (
        </span><span class="token interpolation"><span class="token punctuation">{</span>columns_definition<span class="token punctuation">}</span></span><span class="token string">,
        `change_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        `change_type` VARCHAR(10)
    ) CHARACTER SET utf8mb4;
    &quot;&quot;&quot;</span></span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>history_table_sql<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;History table </span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string"> created.&quot;</span></span><span class="token punctuation">)</span>

<span class="token comment"># 删除表上的所有触发器</span>
<span class="token keyword">def</span> <span class="token function">delete_triggers</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;SHOW TRIGGERS LIKE '</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">';&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> trigger <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        trigger_name <span class="token operator">=</span> trigger<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Deleting trigger: </span><span class="token interpolation"><span class="token punctuation">{</span>trigger_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;DROP TRIGGER IF EXISTS `</span><span class="token interpolation"><span class="token punctuation">{</span>trigger_name<span class="token punctuation">}</span></span><span class="token string">`;&quot;</span></span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 创建触发器 SQL</span>
<span class="token keyword">def</span> <span class="token function">create_trigger_sql</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> history_table<span class="token punctuation">,</span> trigger_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    action <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'INSERT'</span><span class="token punctuation">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> <span class="token string">'UPDATE'</span><span class="token punctuation">:</span> <span class="token string">'NEW'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">:</span> <span class="token string">'OLD'</span><span class="token punctuation">}</span><span class="token punctuation">[</span>trigger_type<span class="token punctuation">]</span>
    action_fields <span class="token operator">=</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>action<span class="token punctuation">}</span></span><span class="token string">.`</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">`'</span></span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns<span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    history_columns <span class="token operator">=</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;`</span><span class="token interpolation"><span class="token punctuation">{</span>col<span class="token punctuation">}</span></span><span class="token string">`&quot;</span></span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'change_at'</span><span class="token punctuation">,</span> <span class="token string">'change_type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    action_values <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>action_fields<span class="token punctuation">}</span></span><span class="token string">, NOW(), '</span><span class="token interpolation"><span class="token punctuation">{</span>trigger_type<span class="token punctuation">}</span></span><span class="token string">'&quot;</span></span>

    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;
    CREATE TRIGGER `</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>trigger_type<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">`
    BEFORE </span><span class="token interpolation"><span class="token punctuation">{</span>trigger_type<span class="token punctuation">}</span></span><span class="token string"> ON `</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">`
    FOR EACH ROW
    BEGIN
        SET @trigger_status = (SELECT status FROM config_table WHERE config_item = '</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_trigger');
        IF @trigger_status = 1 THEN
            INSERT INTO `</span><span class="token interpolation"><span class="token punctuation">{</span>history_table<span class="token punctuation">}</span></span><span class="token string">` (</span><span class="token interpolation"><span class="token punctuation">{</span>history_columns<span class="token punctuation">}</span></span><span class="token string">)
            VALUES (</span><span class="token interpolation"><span class="token punctuation">{</span>action_values<span class="token punctuation">}</span></span><span class="token string">);
        END IF;
    END;
    &quot;&quot;&quot;</span></span>

<span class="token comment"># 创建所有触发器</span>
<span class="token keyword">def</span> <span class="token function">create_triggers</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    columns <span class="token operator">=</span> get_columns<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
    history_table <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">_history&quot;</span></span>
    
    <span class="token keyword">for</span> trigger_type <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'INSERT'</span><span class="token punctuation">,</span> <span class="token string">'UPDATE'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        trigger_sql <span class="token operator">=</span> create_trigger_sql<span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> history_table<span class="token punctuation">,</span> trigger_type<span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>trigger_sql<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 主函数</span>
<span class="token keyword">def</span> <span class="token function">update_triggers</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> closing<span class="token punctuation">(</span>mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token operator">**</span>db_config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">,</span> closing<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;SET NAMES utf8mb4;&quot;</span><span class="token punctuation">)</span>  <span class="token comment"># 设置会话字符集</span>
            drop_history_table_if_exists<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            create_history_table<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            delete_triggers<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            create_triggers<span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;触发器和历史表更新成功: </span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string"> 表的触发器和历史表已更新！&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;出现错误: </span><span class="token interpolation"><span class="token punctuation">{</span>err<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    table_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sch_report_data_gbbk_gzgz'</span><span class="token punctuation">]</span>  <span class="token comment"># 将表名作为参数传入</span>
    <span class="token keyword">for</span> table_name <span class="token keyword">in</span> table_names<span class="token punctuation">:</span>
        update_triggers<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span>
</code></pre></div></details></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/func/assets/js/app.25566812.js" defer></script><script src="/func/assets/js/2.cfd2aafd.js" defer></script><script src="/func/assets/js/1.959a7dda.js" defer></script><script src="/func/assets/js/24.d3d3c175.js" defer></script><script src="/func/assets/js/18.8d0a14c5.js" defer></script>
  </body>
</html>
